{% extends "base.html" %}

{% block title %}Counselling Schedule{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <h1 class="font-playfair text-4xl font-bold text-gray-900 dark:text-white" data-lang-en="Counselling Schedule" data-lang-hi="परामर्श अनुसूची">Counselling Schedule</h1>
        <div class="flex items-center gap-4">
            <a href="{{ url_for('dashboard') }}" class="flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white font-poppins text-sm">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                <span data-lang-en="Back to Dashboard" data-lang-hi="डैशबोर्ड पर वापस जाएं">Back to Dashboard</span>
            </a>
            <label for="schedule-date" class="font-poppins font-medium text-gray-700 dark:text-gray-300" data-lang-en="Select Date:" data-lang-hi="तारीख चुनें:">Select Date:</label>
            <input type="date" id="schedule-date" value="{{ day }}" class="bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-200 rounded-full px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {% if students %}
            {% for student_details in students %}
                <div class="student-card bg-white/50 dark:bg-slate-800/50 backdrop-blur-xl rounded-2xl shadow-lg p-6 space-y-4" data-internal-id="{{ student_details.summary.internal_id }}">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gray-200 dark:bg-slate-700 rounded-full flex items-center justify-center">
                            <i data-lucide="user" class="w-8 h-8 text-gray-600 dark:text-gray-300"></i>
                        </div>
                        <div>
                            <h3 class="font-poppins font-bold text-xl text-gray-900 dark:text-white">{{ student_details.summary['Student Name'] }}</h3>
                            <p class="font-poppins text-sm text-gray-500 dark:text-gray-400">ID: {{ student_details.summary['Student ID'] }}</p>
                        </div>
                    </div>
                    
                    {% set risk_level = student_details.summary.Risk_Level %}
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium
                        {% if risk_level == 'High' %} bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300
                        {% elif risk_level == 'Medium' %} bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300
                        {% else %} bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300 {% endif %}">
                        <span data-lang-en="{{ risk_level }} Risk" data-lang-hi="{% if risk_level == 'High' %}उच्च{% elif risk_level == 'Medium' %}मध्यम{% else %}कम{% endif %} जोखिम">{{ risk_level }} Risk</span>
                    </div>

                    <div class="space-y-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <p class="font-poppins text-sm"><strong class="text-gray-600 dark:text-gray-400" data-lang-en="Course:" data-lang-hi="कोर्स:">Course:</strong> <span class="text-gray-800 dark:text-gray-200">{{ student_details.summary.Course }}</span></p>
                        <p class="font-poppins text-sm"><strong class="text-gray-600 dark:text-gray-400" data-lang-en="Parent Mail:" data-lang-hi="अभिभावक का मेल:">Parent Mail:</strong> <span class="text-gray-800 dark:text-gray-200">{{ student_details.summary['Parent Mail'] }}</span></p>
                        <p class="font-poppins text-sm"><strong class="text-gray-600 dark:text-gray-400" data-lang-en="Key Remarks:" data-lang-hi="मुख्य टिप्पणियां:">Key Remarks:</strong> <span class="text-gray-800 dark:text-gray-200">{{ student_details.summary.Remarks }}</span></p>
                    </div>

                    <div class="pt-4 border-t border-gray-200 dark:border-gray-700 space-y-3">
                        <div class="flex items-center gap-2">
                            <button class="reschedule-btn w-full flex items-center justify-center gap-2 bg-yellow-500 text-white font-poppins font-medium px-4 py-2 rounded-full hover:bg-yellow-600 transition-colors text-sm">
                                <i data-lucide="calendar-clock" class="w-4 h-4"></i>
                                <span data-lang-en="Reschedule" data-lang-hi="पुनर्निर्धारित करें">Reschedule</span>
                            </button>
                            <button class="end-counselling-btn w-full flex items-center justify-center gap-2 bg-red-600 text-white font-poppins font-medium px-4 py-2 rounded-full hover:bg-red-700 transition-colors text-sm">
                                <i data-lucide="calendar-x-2" class="w-4 h-4"></i>
                                <span data-lang-en="End Session" data-lang-hi="सत्र समाप्त करें">End Session</span>
                            </button>
                        </div>
                        <div class="reschedule-form hidden space-y-2">
                            <input type="date" class="reschedule-date-input bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-200 rounded-full w-full px-4 py-2">
                            <button class="confirm-reschedule-btn w-full bg-green-600 text-white font-poppins font-medium px-4 py-2 rounded-full hover:bg-green-700 transition-colors text-sm" data-lang-en="Confirm" data-lang-hi="पुष्टि करें">Confirm</button>
                        </div>
                        <p class="feedback-message text-xs text-center font-poppins"></p>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-span-full text-center py-20">
                <i data-lucide="calendar-x" class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-500"></i>
                <p class="mt-4 font-poppins text-lg text-gray-600 dark:text-gray-400" data-lang-en="No students scheduled for this day." data-lang-hi="इस दिन के लिए कोई छात्र निर्धारित नहीं है।">No students scheduled for this day.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const datePicker = document.getElementById('schedule-date');
    datePicker.addEventListener('change', () => {
        window.location.href = `/counselling?day=${datePicker.value}`;
    });

    document.querySelectorAll('.student-card').forEach(card => {
        const internalId = card.dataset.internalId;
        const rescheduleBtn = card.querySelector('.reschedule-btn');
        const endCounsellingBtn = card.querySelector('.end-counselling-btn');
        const rescheduleForm = card.querySelector('.reschedule-form');
        const confirmRescheduleBtn = card.querySelector('.confirm-reschedule-btn');
        const rescheduleDateInput = card.querySelector('.reschedule-date-input');
        const feedbackMessage = card.querySelector('.feedback-message');

        rescheduleBtn.addEventListener('click', () => {
            rescheduleForm.classList.toggle('hidden');
        });

        endCounsellingBtn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to end this counselling session?')) {
                try {
                    const response = await fetch('/api/end-counselling', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ day: '{{ day }}', internal_id: parseInt(internalId) })
                    });
                    const result = await response.json();
                    if (result.success) {
                        card.style.transition = 'opacity 0.5s ease';
                        card.style.opacity = '0';
                        setTimeout(() => card.remove(), 500);
                    } else {
                        feedbackMessage.textContent = result.message;
                        feedbackMessage.className = 'feedback-message text-xs text-center font-poppins text-red-600';
                    }
                } catch (error) {
                    feedbackMessage.textContent = 'An error occurred.';
                    feedbackMessage.className = 'feedback-message text-xs text-center font-poppins text-red-600';
                }
            }
        });

        confirmRescheduleBtn.addEventListener('click', async () => {
            const newDate = rescheduleDateInput.value;
            if (!newDate) {
                feedbackMessage.textContent = 'Please select a new date.';
                feedbackMessage.className = 'feedback-message text-xs text-center font-poppins text-red-600';
                return;
            }

            try {
                const response = await fetch('/api/reschedule-counselling', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
     old_day: '{{ day }}',
     new_day: newDate,
     student_db_id: parseInt(internalId)
 })
                });
                const result = await response.json();
                feedbackMessage.textContent = result.message;
                if (result.success) {
                    feedbackMessage.className = 'feedback-message text-xs text-center font-poppins text-green-600';
                    card.style.transition = 'opacity 0.5s ease';
                    card.style.opacity = '0';
                    setTimeout(() => card.remove(), 500);
                } else {
                    feedbackMessage.className = 'feedback-message text-xs text-center font-poppins text-red-600';
                }
            } catch (error) {
                feedbackMessage.textContent = 'An error occurred.';
                feedbackMessage.className = 'feedback-message text-xs text-center font-poppins text-red-600';
            }
        });
    });
});
</script>
{% endblock %}

