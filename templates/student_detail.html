{% extends "base.html" %}

{% block title %}Student Details{% endblock %}

{% block content %}
<div class="absolute inset-0 -z-10 overflow-hidden">
    <div class="floating-icon" style="left: 15%; top: 15%; animation-duration: 20s;"><i data-lucide="book-open" class="w-12 h-12 text-indigo-500"></i></div>
    <div class="floating-icon" style="left: 75%; top: 25%; animation-duration: 24s;"><i data-lucide="dollar-sign" class="w-16 h-16 text-emerald-500"></i></div>
    <div class="floating-icon" style="left: 20%; top: 75%; animation-duration: 28s;"><i data-lucide="home" class="w-8 h-8 text-sky-500"></i></div>
    <div class="floating-icon" style="left: 85%; top: 85%; animation-duration: 18s;"><i data-lucide="user" class="w-10 h-10 text-rose-500"></i></div>
</div>

<div id="student-detail-content" class="space-y-8">
    <div class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-xl rounded-2xl shadow-lg p-8">
        <div class="flex flex-col md:flex-row md:items-center gap-6">
            <div class="w-20 h-20 bg-gray-900 dark:bg-slate-700 rounded-full flex items-center justify-center flex-shrink-0">
                <i data-lucide="user" class="w-10 h-10 text-white"></i>
            </div>
            <div class="flex-grow">
                <h1 class="font-playfair text-3xl font-bold text-gray-900 dark:text-white">
                    <span data-lang-en="Student:" data-lang-hi="छात्र:">Student:</span>
                    {{ student.summary['Student Name'] or 'N/A' }}
                </h1>
                <p class="font-poppins text-gray-600 dark:text-gray-400 mt-1">
                    <span data-lang-en="Student ID:" data-lang-hi="छात्र आईडी:">Student ID:</span> {{ student.summary['Student ID'] or 'N/A' }} •
                    <span data-lang-en="Course:" data-lang-hi="कोर्स:">Course:</span> {{ student.summary.Course }}
                </p>
                <div class="mt-4 flex flex-col sm:flex-row sm:items-center gap-4">
                    {% set risk_level = student.summary.Risk_Level %}
                    {% set prob = student.summary.Dropout_Probability * 100 %}
                    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full font-poppins font-medium
                        {% if risk_level == 'High' %} bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300
                        {% elif risk_level == 'Medium' %} bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300
                        {% else %} bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300 {% endif %}">
                        
                        {% if risk_level == 'High' %}<i data-lucide="alert-triangle" class="w-4 h-4"></i>
                        {% elif risk_level == 'Medium' %}<i data-lucide="info" class="w-4 h-4"></i>
                        {% else %}<i data-lucide="check-circle" class="w-4 h-4"></i>{% endif %}
                        <span data-lang-en="{{ risk_level }} Risk" data-lang-hi="{% if risk_level == 'High' %}उच्च{% elif risk_level == 'Medium' %}मध्यम{% else %}कम{% endif %} जोखिम">{{ risk_level }} Risk</span>
                        <span class="text-sm opacity-75">(<span data-lang-en="probability" data-lang-hi="संभावना">probability</span> {{ "%.1f"|format(prob) }}%)</span>
                    </div>
                    <div class="bg-gray-100 dark:bg-slate-700 rounded-full p-4">
                        <p class="font-poppins text-sm text-gray-700 dark:text-gray-300">
                            <span class="font-semibold" data-lang-en="Key Risk Factors:" data-lang-hi="मुख्य जोखिम कारक:">Key Risk Factors:</span> {{ student.summary.Remarks }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-xl rounded-2xl shadow-lg p-6">
        <h3 class="font-playfair text-xl font-bold text-gray-900 dark:text-white mb-4" data-lang-en="Assign to Counselling" data-lang-hi="परामर्श के लिए असाइन करें">Assign to Counselling</h3>
        <div class="flex flex-col sm:flex-row items-center gap-4">
            <input type="date" id="counselling-date" class="bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-200 rounded-full px-4 py-2 focus:ring-2 focus:ring-blue-500">
            <button id="assign-btn" class="bg-blue-600 text-white font-poppins font-medium px-6 py-2 rounded-full hover:bg-blue-700 transition-colors">
                <span data-lang-en="Assign" data-lang-hi="असाइन करें">Assign</span>
            </button>
        </div>
        <p id="assign-message" class="text-sm mt-3 font-poppins"></p>
    </div>

    <div class="flex flex-wrap gap-3" id="tab-buttons">
        <button data-tab="academic" class="tab-button active flex items-center gap-2 px-4 py-2 rounded-full font-poppins font-medium text-sm">
            <i data-lucide="book-open" class="w-4 h-4"></i> <span data-lang-en="Academic Info" data-lang-hi="शैक्षणिक जानकारी">Academic Info</span>
        </button>
        <button data-tab="demographics" class="tab-button flex items-center gap-2 px-4 py-2 rounded-full font-poppins font-medium text-sm">
            <i data-lucide="user" class="w-4 h-4"></i> <span data-lang-en="Demographics" data-lang-hi="जनसांख्यिकी">Demographics</span>
        </button>
        <button data-tab="financial" class="tab-button flex items-center gap-2 px-4 py-2 rounded-full font-poppins font-medium text-sm">
            <i data-lucide="dollar-sign" class="w-4 h-4"></i> <span data-lang-en="Financial Status" data-lang-hi="वित्तीय स्थिति">Financial Status</span>
        </button>
        <button data-tab="family" class="tab-button flex items-center gap-2 px-4 py-2 rounded-full font-poppins font-medium text-sm">
            <i data-lucide="home" class="w-4 h-4"></i> <span data-lang-en="Family Background" data-lang-hi="पारिवारिक पृष्ठभूमि">Family Background</span>
        </button>
    </div>

    <div class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-xl rounded-2xl shadow-lg overflow-hidden">
        <div class="p-6 border-b border-gray-200/80 dark:border-gray-700/80">
            <h2 id="tab-title" class="font-playfair text-xl font-bold text-gray-900 dark:text-white" data-lang-en="Academic Info" data-lang-hi="शैक्षणिक जानकारी">Academic Info</h2>
        </div>
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for category, data_list in [('academic', student.academic), ('demographics', student.demographics), ('financial', student.financial), ('family', student.family)] %}
                {% for item in data_list %}
                <div data-content-tab="{{ category }}" class="tab-content">
                    <div class="bg-gray-50/80 dark:bg-slate-700/50 rounded-xl p-4">
                        <p class="font-poppins font-semibold text-sm text-gray-600 dark:text-gray-400" data-lang-en="{{ item.label_en }}" data-lang-hi="{{ item.label_hi }}">{{ item.label_en }}</p>
                        <p class="font-poppins text-gray-900 dark:text-white text-lg mt-1">{{ item.value if item.value is not none else 'N/A' }}</p>
                    </div>
                </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>
    
    {% if student.summary.Risk_Level == 'High' %}
    <div class="bg-red-100/80 dark:bg-red-900/20 backdrop-blur-xl rounded-2xl border border-red-200 dark:border-red-800/50 p-6">
        <div class="flex items-start gap-3">
            <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600 dark:text-red-400 mt-0.5 flex-shrink-0"></i>
            <div class="space-y-3">
                <h3 class="font-poppins font-bold text-red-800 dark:text-red-300" data-lang-en="Immediate Action Recommended" data-lang-hi="तत्काल कार्रवाई की सिफारिश की">Immediate Action Recommended</h3>
                <p class="font-poppins text-red-700 dark:text-red-400" data-lang-en="This student has been flagged as high-risk for dropout. Consider the following interventions:" data-lang-hi="इस छात्र को ड्रॉपआउट के लिए उच्च जोखिम के रूप में चिह्नित किया गया है। निम्नलिखित हस्तक्षेपों पर विचार करें:">This student has been flagged as high-risk for dropout. Consider the following interventions:</p>
                <ul class="space-y-2 font-poppins text-sm text-red-700 dark:text-red-400 list-disc list-inside">
                    <li data-lang-en="Schedule immediate counseling session" data-lang-hi="तत्काल परामर्श सत्र निर्धारित करें">Schedule immediate counseling session</li>
                    <li data-lang-en="Review financial aid options if applicable" data-lang-hi="यदि लागू हो तो वित्तीय सहायता विकल्पों की समीक्षा करें">Review financial aid options if applicable</li>
                    <li data-lang-en="Connect with academic support services" data-lang-hi="शैक्षणिक सहायता सेवाओं से जुड़ें">Connect with academic support services</li>
                    <li data-lang-en="Monitor attendance and engagement closely" data-lang-hi="उपस्थिति और जुड़ाव की बारीकी से निगरानी करें">Monitor attendance and engagement closely</li>
                </ul>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<style>
    .tab-button { background-color: #F3F4F6; color: #6B7280; transition: all 0.2s ease-in-out; }
    html.dark .tab-button { background-color: #334155; color: #94a3b8; }
    .tab-button.active { background-color: #111827; color: white; }
    html.dark .tab-button.active { background-color: #e2e8f0; color: #1e293b; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-30px); } 100% { transform: translateY(0px); } }
    .floating-icon { position: absolute; opacity: 0.1; animation: float 20s ease-in-out infinite; }
    html.dark .floating-icon { opacity: 0.05; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    #student-detail-content > div { animation: fadeInUp 0.6s ease-out forwards; opacity: 0; }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const tabTitle = document.getElementById('tab-title');
    const tabData = {
        en: {'academic': 'Academic Info', 'demographics': 'Demographics', 'financial': 'Financial Status', 'family': 'Family Background'},
        hi: {'academic': 'शैक्षणिक जानकारी', 'demographics': 'जनसांख्यिकी', 'financial': 'वित्तीय स्थिति', 'family': 'पारिवारिक पृष्ठभूमि'}
    };

    function switchTab(activeTab) {
        const currentLang = localStorage.getItem('language') || 'en';
        tabTitle.innerText = tabData[currentLang][activeTab];
        tabButtons.forEach(button => button.classList.toggle('active', button.dataset.tab === activeTab));
        tabContents.forEach(content => content.classList.toggle('active', content.dataset.contentTab === activeTab));
    }
    tabButtons.forEach(button => button.addEventListener('click', () => switchTab(button.dataset.tab)));
    
    document.addEventListener('languageChange', () => {
        const activeTabButton = document.querySelector('.tab-button.active');
        if (activeTabButton) {
            switchTab(activeTabButton.dataset.tab);
        }
    });

    switchTab('academic');

    const assignBtn = document.getElementById('assign-btn');
    const counsellingDate = document.getElementById('counselling-date');
    const assignMessage = document.getElementById('assign-message');
    const internalId = {{ internal_id|tojson }};

    let tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    if (tomorrow.getDay() === 0) { tomorrow.setDate(tomorrow.getDate() + 1); }
    else if (tomorrow.getDay() === 6) { tomorrow.setDate(tomorrow.getDate() + 2); }
    counsellingDate.value = tomorrow.toISOString().split('T')[0];

    assignBtn.addEventListener('click', async () => {
        const date = counsellingDate.value;
        if (!date) {
            assignMessage.textContent = 'Please select a date.';
            assignMessage.className = 'text-sm mt-3 font-poppins text-red-600';
            return;
        }
        assignMessage.textContent = 'Assigning...';
        assignMessage.className = 'text-sm mt-3 font-poppins text-gray-600';

        try {
            const response = await fetch('/api/assign-counselling', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ day: date, student_db_id: internalId })
            });
            const result = await response.json();
            assignMessage.textContent = result.message;
            assignMessage.className = `text-sm mt-3 font-poppins ${result.success ? 'text-green-600' : 'text-red-600'}`;
        } catch (error) {
            assignMessage.textContent = 'An error occurred. Please try again.';
            assignMessage.className = 'text-sm mt-3 font-poppins text-red-600';
        }
    });
});
</script>
{% endblock %}

